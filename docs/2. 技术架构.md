# ğŸ“ tzjingtai-erp  
# **æŠ€æœ¯æ¶æ„æ–‡æ¡£ï¼ˆTechnical Architecture v1.0ï¼‰**

---

## 1. æŠ€æœ¯æ ˆæ€»è§ˆ

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
```
é¡¹ç›®ç®¡ç†ï¼šTurborepo (Monorepo)
å‰ç«¯ï¼šNext.js 15+ (App Router) + React 19+ + TypeScript 5+
åç«¯ï¼šNest.js 11+ + TypeScript 5+
è¿è¡Œæ—¶ï¼šNode.js 24 LTS
æ•°æ®åº“ï¼šPostgreSQL 17+
ORMï¼šPrisma 6+
UI ç»„ä»¶ï¼šshadcn/ui (latest) + Radix UI (latest) + Tailwind CSS 4+
```

### Monorepo æ¶æ„
```
tzjingtai-erp/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/              # Next.js å‰ç«¯åº”ç”¨
â”‚   â””â”€â”€ api/              # Nest.js åç«¯åº”ç”¨
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ ui/               # å…±äº« UI ç»„ä»¶åº“
â”‚   â”œâ”€â”€ database/         # Prisma Schema + æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ types/            # å…±äº« TypeScript ç±»å‹
â”‚   â”œâ”€â”€ utils/            # å…±äº«å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ config/           # å…±äº«é…ç½®ï¼ˆESLint, TypeScriptï¼‰
â”‚   â””â”€â”€ validators/       # å…±äº«éªŒè¯è§„åˆ™ï¼ˆZod schemasï¼‰
â”œâ”€â”€ turbo.json            # Turborepo é…ç½®
â”œâ”€â”€ package.json          # æ ¹ package.json
â””â”€â”€ pnpm-lock.yaml        # pnpm é”æ–‡ä»¶
```

---

## 2. Monorepo æ¶æ„è®¾è®¡

### 2.1 Turborepo é…ç½®

**æŠ€æœ¯é€‰å‹ç†ç”±**
- Turborepoï¼šä¸“ä¸º Monorepo è®¾è®¡ï¼Œå¢é‡æ„å»ºï¼Œè¿œç¨‹ç¼“å­˜
- pnpm Workspacesï¼šé«˜æ•ˆçš„åŒ…ç®¡ç†ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´

### 2.2 é¡¹ç›®ç»“æ„

```
tzjingtai-erp/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                      # Next.js å‰ç«¯åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â””â”€â”€ api/                      # Nest.js åç«¯åº”ç”¨
â”‚       â”œâ”€â”€ src/
â”‚       â”œâ”€â”€ test/
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ tsconfig.json
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ ui/                       # å…±äº« UI ç»„ä»¶åº“
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/       # shadcn/ui ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ database/                 # Prisma æ•°æ®åº“åŒ…
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”‚   â”œâ”€â”€ schema.prisma
â”‚   â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”‚   â””â”€â”€ seed.ts
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts         # Prisma Client å¯¼å‡º
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ types/                    # å…±äº« TypeScript ç±»å‹
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/              # API ç±»å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/           # é¢†åŸŸæ¨¡å‹ç±»å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/              # DTO ç±»å‹
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ utils/                    # å…±äº«å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ date.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ currency.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ format.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ validators/               # å…±äº«éªŒè¯è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ voucher.schema.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ invoice.schema.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â””â”€â”€ config/                   # å…±äº«é…ç½®
â”‚       â”œâ”€â”€ eslint/
â”‚       â”‚   â””â”€â”€ index.js
â”‚       â”œâ”€â”€ typescript/
â”‚       â”‚   â”œâ”€â”€ base.json
â”‚       â”‚   â”œâ”€â”€ nextjs.json
â”‚       â”‚   â””â”€â”€ nestjs.json
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ turbo.json                    # Turborepo é…ç½®
â”œâ”€â”€ package.json                  # æ ¹ package.json
â”œâ”€â”€ pnpm-lock.yaml                # pnpm é”æ–‡ä»¶
â”œâ”€â”€ pnpm-workspace.yaml           # pnpm workspace é…ç½®
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

### 2.3 åŒ…ä¾èµ–å…³ç³»

```
apps/web
  â”œâ”€â”€ @repo/ui
  â”œâ”€â”€ @repo/types
  â”œâ”€â”€ @repo/utils
  â”œâ”€â”€ @repo/validators
  â””â”€â”€ @repo/config

apps/api
  â”œâ”€â”€ @repo/database
  â”œâ”€â”€ @repo/types
  â”œâ”€â”€ @repo/utils
  â”œâ”€â”€ @repo/validators
  â””â”€â”€ @repo/config

packages/ui
  â””â”€â”€ @repo/types

packages/database
  â””â”€â”€ @repo/types
```

### 2.4 Turborepo é…ç½®æ–‡ä»¶

**turbo.json**
```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "dependsOn": ["^lint"]
    },
    "type-check": {
      "dependsOn": ["^type-check"]
    },
    "test": {
      "dependsOn": ["^build"]
    },
    "db:generate": {
      "cache": false
    },
    "db:push": {
      "cache": false
    },
    "db:migrate": {
      "cache": false
    }
  }
}
```

**æ ¹ package.json**
```json
{
  "name": "tzjingtai-erp",
  "version": "1.0.0",
  "private": true,
  "engines": {
    "node": ">=24.0.0",
    "pnpm": ">=9.0.0"
  },
  "packageManager": "pnpm@9.0.0",
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "lint": "turbo run lint",
    "type-check": "turbo run type-check",
    "test": "turbo run test",
    "db:generate": "turbo run db:generate",
    "db:push": "turbo run db:push",
    "db:migrate": "turbo run db:migrate",
    "clean": "turbo run clean && rm -rf node_modules"
  },
  "devDependencies": {
    "turbo": "^2.0.0",
    "@repo/config": "workspace:*",
    "typescript": "^5.6.0"
  }
}
```

**pnpm-workspace.yaml**
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

### 2.5 å…±äº«åŒ…è¯´æ˜

#### @repo/ui
- æ‰€æœ‰ shadcn/ui ç»„ä»¶
- ä¸šåŠ¡é€šç”¨ç»„ä»¶ï¼ˆVoucherForm, AccountSelector ç­‰ï¼‰
- æ ·å¼é…ç½®ï¼ˆTailwindï¼‰

#### @repo/database
- Prisma Schema
- Prisma Client å¯¼å‡º
- æ•°æ®åº“è¿ç§»
- Seed è„šæœ¬

#### @repo/types
- API è¯·æ±‚/å“åº”ç±»å‹
- é¢†åŸŸæ¨¡å‹ç±»å‹
- Enum å®šä¹‰
- å‰åç«¯å…±äº«ç±»å‹

#### @repo/utils
- æ—¥æœŸæ ¼å¼åŒ–
- è´§å¸è®¡ç®—
- å­—ç¬¦ä¸²å¤„ç†
- é€šç”¨å·¥å…·å‡½æ•°

#### @repo/validators
- Zod Schema å®šä¹‰
- å‰åç«¯å…±äº«éªŒè¯è§„åˆ™
- è‡ªå®šä¹‰éªŒè¯å™¨

#### @repo/config
- ESLint é…ç½®
- TypeScript é…ç½®
- Prettier é…ç½®

### 2.6 Monorepo ä¼˜åŠ¿

- **ä»£ç å¤ç”¨**ï¼šUI ç»„ä»¶ã€ç±»å‹ã€å·¥å…·å‡½æ•°ç»Ÿä¸€ç®¡ç†
- **ç±»å‹å®‰å…¨**ï¼šå‰åç«¯å…±äº«ç±»å‹å®šä¹‰ï¼Œé¿å…ä¸ä¸€è‡´
- **ç»Ÿä¸€æ„å»º**ï¼šTurborepo å¢é‡æ„å»ºï¼Œæå‡æ•ˆç‡
- **ä¾èµ–ç®¡ç†**ï¼šç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†ï¼Œé¿å…å†²çª
- **å¼€å‘ä½“éªŒ**ï¼šä¸€æ¬¡å¯åŠ¨ï¼Œå‰åç«¯åŒæ—¶å¼€å‘

---

## 3. ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯å±‚ (Next.js)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Web UI      â”‚  â”‚  API Routes  â”‚  â”‚  SSR/SSG     â”‚      â”‚
â”‚  â”‚ (shadcn/ui)  â”‚  â”‚  (BFFå±‚)     â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP/REST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯å±‚ (Nest.js)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Controller Layer (API)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Service Layer (ä¸šåŠ¡é€»è¾‘)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Domain Layer (é¢†åŸŸæ¨¡å‹)                   â”‚   â”‚
â”‚  â”‚  â€¢ Event Engine  â€¢ PostingRule Engine                â”‚   â”‚
â”‚  â”‚  â€¢ Voucher Engine  â€¢ Permission Engine               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Repository Layer (æ•°æ®è®¿é—®)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ Prisma ORM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å±‚ (PostgreSQL)                         â”‚
â”‚  â€¢ å¤šå…¬å¸éš”ç¦»  â€¢ å¤šè´¦ç°¿éš”ç¦»  â€¢ äº‹åŠ¡ä¸€è‡´æ€§                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. å‰ç«¯æ¶æ„

### 4.1 æŠ€æœ¯é€‰å‹

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Next.js | 15+ | React æ¡†æ¶ï¼ˆApp Routerï¼‰ |
| React | 19+ | UI æ¡†æ¶ |
| TypeScript | 5+ | ç±»å‹å®‰å…¨ |
| shadcn/ui | latest | UI ç»„ä»¶åº“ |
| Radix UI | latest | æ— æ ·å¼ç»„ä»¶åŸºç¡€ |
| Tailwind CSS | 4+ | æ ·å¼æ¡†æ¶ |
| Zustand | 5+ | çŠ¶æ€ç®¡ç† |
| React Hook Form | 7+ | è¡¨å•ç®¡ç† |
| Zod | 3+ | è¡¨å•éªŒè¯ |
| TanStack Query | 5+ | æ•°æ®è·å–/ç¼“å­˜ |
| TanStack Table | 8+ | è¡¨æ ¼ç»„ä»¶ |
| date-fns | 4+ | æ—¥æœŸå¤„ç† |
| Recharts | 2+ | å›¾è¡¨åº“ |

### 4.2 ç›®å½•ç»“æ„ï¼ˆapps/webï¼‰

```
apps/web/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/                   # è®¤è¯è·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”œâ”€â”€ (dashboard)/              # ä¸»åº”ç”¨è·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ finance/              # è´¢åŠ¡æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ vouchers/
â”‚   â”‚   â”‚   â”œâ”€â”€ gl-entries/
â”‚   â”‚   â”‚   â””â”€â”€ chart-of-accounts/
â”‚   â”‚   â”œâ”€â”€ business/             # ä¸šåŠ¡æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ accept-bills/
â”‚   â”‚   â”‚   â”œâ”€â”€ vat-invoices/
â”‚   â”‚   â”‚   â””â”€â”€ payments/
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”œâ”€â”€ api/                      # API Routes (BFF)
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ components/                   # é¡µé¢çº§ç»„ä»¶
â”‚   â”œâ”€â”€ forms/                    # è¡¨å•ç»„ä»¶
â”‚   â”œâ”€â”€ tables/                   # è¡¨æ ¼ç»„ä»¶
â”‚   â””â”€â”€ layouts/                  # å¸ƒå±€ç»„ä»¶
â”œâ”€â”€ lib/                          # å·¥å…·åº“
â”‚   â”œâ”€â”€ api-client.ts             # API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ utils.ts
â”œâ”€â”€ hooks/                        # è‡ªå®šä¹‰ Hooks
â”œâ”€â”€ stores/                       # Zustand stores
â”œâ”€â”€ public/                       # é™æ€èµ„æº
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

### 4.3 UI ç»„ä»¶è§„èŒƒï¼ˆpackages/uiï¼‰

**åŸºç¡€ç»„ä»¶ï¼ˆshadcn/uiï¼‰**
- Button, Input, Select, Checkbox, Radio
- Dialog, Sheet, Popover, Dropdown Menu
- Table, Card, Tabs, Badge, Alert
- Form, Label, Textarea
- Calendar, DatePicker
- Toast, Tooltip

**ä¸šåŠ¡ç»„ä»¶**
- VoucherFormï¼ˆå‡­è¯å½•å…¥è¡¨å•ï¼‰
- VoucherTableï¼ˆå‡­è¯åˆ—è¡¨ï¼‰
- AccountSelectorï¼ˆç§‘ç›®é€‰æ‹©å™¨ï¼‰
- AuxiliarySelectorï¼ˆè¾…åŠ©æ ¸ç®—é€‰æ‹©å™¨ï¼‰
- CurrencyInputï¼ˆè´§å¸è¾“å…¥æ¡†ï¼‰
- AttachmentUploaderï¼ˆé™„ä»¶ä¸Šä¼ ï¼‰
- AuditLogViewerï¼ˆå®¡è®¡æ—¥å¿—æŸ¥çœ‹å™¨ï¼‰

### 4.4 å‰ç«¯ç‰¹æ€§

- **å¿«æ·é”®æ”¯æŒ**ï¼šè´¢åŠ¡å½•å…¥åœºæ™¯ï¼ˆCtrl+S ä¿å­˜ã€Ctrl+Enter æäº¤ç­‰ï¼‰
- **æ‰¹é‡ç¼–è¾‘**ï¼šå‡­è¯åˆ†å½•æ‰¹é‡å½•å…¥
- **å®æ—¶éªŒè¯**ï¼šå€Ÿè´·å¹³è¡¡æ ¡éªŒ
- **ç¦»çº¿ç¼“å­˜**ï¼šTanStack Query ç¼“å­˜ç­–ç•¥
- **æƒé™æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„ UI æ˜¾ç¤º/éšè—

---

## 5. åç«¯æ¶æ„

### 5.1 æŠ€æœ¯é€‰å‹

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Node.js | 24 LTS | JavaScript è¿è¡Œæ—¶ |
| Nest.js | 11+ | Node.js æ¡†æ¶ |
| TypeScript | 5+ | ç±»å‹å®‰å…¨ |
| Prisma | 6+ | ORM |
| PostgreSQL | 17+ | å…³ç³»å‹æ•°æ®åº“ |
| class-validator | 0.14+ | DTO éªŒè¯ |
| class-transformer | 0.5+ | å¯¹è±¡è½¬æ¢ |
| Passport.js | 0.7+ | è®¤è¯ä¸­é—´ä»¶ |
| @nestjs/jwt | 10+ | JWT è®¤è¯ |
| bcrypt | 5+ | å¯†ç åŠ å¯† |
| Winston | 3+ | æ—¥å¿—æ¡†æ¶ |
| Bull | 4+ | ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¯é€‰ï¼‰ |
| ali-oss | 6+ | é˜¿é‡Œäº‘ OSS SDK |
| @alicloud/ocr | latest | é˜¿é‡Œäº‘ OCR SDK |

### 5.2 ç›®å½•ç»“æ„ï¼ˆapps/apiï¼‰

```
apps/api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                   # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ app.module.ts             # æ ¹æ¨¡å—
â”‚   â”œâ”€â”€ common/                   # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ decorators/           # è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ filters/              # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”‚   â”œâ”€â”€ guards/               # å®ˆå«ï¼ˆæƒé™ï¼‰
â”‚   â”‚   â”œâ”€â”€ interceptors/         # æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ pipes/                # ç®¡é“ï¼ˆéªŒè¯ï¼‰
â”‚   â”œâ”€â”€ config/                   # é…ç½®
â”‚   â”‚   â”œâ”€â”€ database.config.ts
â”‚   â”‚   â”œâ”€â”€ jwt.config.ts
â”‚   â”‚   â””â”€â”€ logger.config.ts
â”‚   â”œâ”€â”€ modules/                  # ä¸šåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth/                 # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ users/                # ç”¨æˆ·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ companies/            # å…¬å¸æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ledgers/              # è´¦ç°¿æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ chart-of-accounts/    # ç§‘ç›®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ vouchers/             # å‡­è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ accounting-events/    # ä¼šè®¡äº‹ä»¶æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ posting-rules/        # è¿‡è´¦è§„åˆ™æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ accept-bills/         # æ‰¿å…‘æ±‡ç¥¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ vat-invoices/         # å¢å€¼ç¨å‘ç¥¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ payments/             # èµ„é‡‘æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ inventory/            # åº“å­˜æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ attachments/          # é™„ä»¶æ¨¡å—
â”‚   â”‚   â””â”€â”€ ocr/                  # OCR è¯†åˆ«æ¨¡å—
â”‚   â””â”€â”€ domain/                   # é¢†åŸŸå±‚
â”‚       â”œâ”€â”€ engines/              # æ ¸å¿ƒå¼•æ“
â”‚       â”‚   â”œâ”€â”€ event.engine.ts
â”‚       â”‚   â”œâ”€â”€ posting-rule.engine.ts
â”‚       â”‚   â””â”€â”€ voucher.engine.ts
â”‚       â”œâ”€â”€ entities/             # é¢†åŸŸå®ä½“
â”‚       â””â”€â”€ value-objects/        # å€¼å¯¹è±¡
â”œâ”€â”€ test/                         # æµ‹è¯•
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

### 5.3 æ¨¡å—ç»“æ„ï¼ˆæ ‡å‡†ï¼‰

æ¯ä¸ªä¸šåŠ¡æ¨¡å—éµå¾ªä»¥ä¸‹ç»“æ„ï¼š

```
module-name/
â”œâ”€â”€ dto/                          # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ create-xxx.dto.ts
â”‚   â”œâ”€â”€ update-xxx.dto.ts
â”‚   â””â”€â”€ query-xxx.dto.ts
â”œâ”€â”€ entities/                     # å®ä½“ï¼ˆå¯é€‰ï¼‰
â”‚   â””â”€â”€ xxx.entity.ts
â”œâ”€â”€ xxx.controller.ts             # æ§åˆ¶å™¨
â”œâ”€â”€ xxx.service.ts                # æœåŠ¡
â”œâ”€â”€ xxx.repository.ts             # ä»“å‚¨ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ xxx.module.ts                 # æ¨¡å—å®šä¹‰
```

---

## 6. æ ¸å¿ƒå¼•æ“è®¾è®¡

### 6.1 ä¼šè®¡äº‹ä»¶å¼•æ“ï¼ˆEvent Engineï¼‰

**èŒè´£**
- æ¥æ”¶ä¸šåŠ¡åŠ¨ä½œè§¦å‘
- åˆ›å»º AccountingEvent è®°å½•
- åŒ¹é… PostingRule
- è°ƒç”¨ Voucher Engine ç”Ÿæˆå‡­è¯è‰ç¨¿

**æ ¸å¿ƒæ–¹æ³•**
```typescript
class EventEngine {
  async createEvent(params: CreateEventParams): Promise<AccountingEvent>
  async processEvent(eventId: string): Promise<Voucher>
  async reverseEvent(eventId: string): Promise<Voucher>
}
```

### 6.2 è¿‡è´¦è§„åˆ™å¼•æ“ï¼ˆPostingRule Engineï¼‰

**èŒè´£**
- æ ¹æ® eventType + ledgerId åŒ¹é…è§„åˆ™
- è§£æ amountFormula
- ç”Ÿæˆå‡­è¯åˆ†å½•ï¼ˆVoucherItemï¼‰

**æ ¸å¿ƒæ–¹æ³•**
```typescript
class PostingRuleEngine {
  async matchRules(eventType: string, ledgerId: string): Promise<PostingRule[]>
  async generateVoucherItems(event: AccountingEvent, rules: PostingRule[]): Promise<VoucherItem[]>
}
```

### 6.3 å‡­è¯å¼•æ“ï¼ˆVoucher Engineï¼‰

**èŒè´£**
- åˆ›å»ºå‡­è¯è‰ç¨¿
- éªŒè¯å€Ÿè´·å¹³è¡¡
- è¿‡è´¦ï¼ˆPostï¼‰
- çº¢å†²ï¼ˆReverseï¼‰
- å†™å…¥æ€»è´¦ï¼ˆGL Entryï¼‰

**æ ¸å¿ƒæ–¹æ³•**
```typescript
class VoucherEngine {
  async createDraft(items: VoucherItem[]): Promise<Voucher>
  async validateBalance(voucher: Voucher): Promise<boolean>
  async post(voucherId: string): Promise<void>
  async reverse(voucherId: string): Promise<Voucher>
}
```

---

## 7. æ•°æ®åº“è®¾è®¡ï¼ˆpackages/databaseï¼‰

### 7.1 PostgreSQL ç‰¹æ€§ä½¿ç”¨

- **äº‹åŠ¡éš”ç¦»çº§åˆ«**ï¼šREAD COMMITTEDï¼ˆé»˜è®¤ï¼‰
- **å¤–é”®çº¦æŸ**ï¼šå¼ºåˆ¶å¼•ç”¨å®Œæ•´æ€§
- **ç´¢å¼•ç­–ç•¥**ï¼š
  - ä¸»é”®è‡ªåŠ¨ç´¢å¼•
  - å¤–é”®å­—æ®µç´¢å¼•
  - æŸ¥è¯¢é«˜é¢‘å­—æ®µï¼ˆcompanyId, ledgerId, statusï¼‰
  - å¤åˆç´¢å¼•ï¼ˆeventType + ledgerIdï¼‰
- **åˆ†åŒºè¡¨**ï¼ˆå¯é€‰ï¼‰ï¼šGLEntry æŒ‰å¹´ä»½åˆ†åŒº
- **è½¯åˆ é™¤**ï¼šdeletedAt å­—æ®µ

### 7.2 Prisma Schema è§„èŒƒ

```prisma
// ç¤ºä¾‹ï¼šVoucher æ¨¡å‹
model Voucher {
  id              String         @id @default(uuid())
  voucherNo       String         @unique
  ledgerId        String
  ledger          Ledger         @relation(fields: [ledgerId], references: [id])
  voucherDate     DateTime
  status          VoucherStatus  @default(DRAFT)
  totalDebit      Decimal        @db.Decimal(18, 2)
  totalCredit     Decimal        @db.Decimal(18, 2)
  eventId         String?        @unique
  event           AccountingEvent? @relation(fields: [eventId], references: [id])
  items           VoucherItem[]
  createdBy       String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  
  @@index([ledgerId, voucherDate])
  @@index([status])
}
```

---

### 7.3 æ•°æ®åº“åŒ…ç»“æ„

```
packages/database/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma             # Prisma Schema
â”‚   â”œâ”€â”€ migrations/               # æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ seed.ts                   # åˆå§‹æ•°æ®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ client.ts                 # Prisma Client å¯¼å‡º
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

**package.json**
```json
{
  "name": "@repo/database",
  "version": "0.0.0",
  "private": true,
  "main": "./src/index.ts",
  "scripts": {
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:migrate": "prisma migrate dev",
    "db:seed": "tsx prisma/seed.ts"
  },
  "dependencies": {
    "@prisma/client": "^6.0.0"
  },
  "devDependencies": {
    "prisma": "^6.0.0",
    "@repo/types": "workspace:*"
  }
}
```

---

## 8. æ–‡ä»¶å­˜å‚¨ä¸ OCR æœåŠ¡

### 8.1 é˜¿é‡Œäº‘ OSS é›†æˆ

**æŠ€æœ¯é€‰å‹**
- **ali-oss**ï¼šé˜¿é‡Œäº‘å®˜æ–¹ Node.js SDK
- **å­˜å‚¨æ¡¶ç­–ç•¥**ï¼šç§æœ‰è¯»å†™ï¼Œé€šè¿‡ç­¾å URL è®¿é—®

**åŠŸèƒ½ç‰¹æ€§**
- é™„ä»¶ä¸Šä¼ ï¼ˆå‡­è¯ã€å‘ç¥¨ã€åˆåŒç­‰ï¼‰
- æ–‡ä»¶ä¸‹è½½ï¼ˆç­¾å URLï¼Œæœ‰æ•ˆæœŸå¯é…ç½®ï¼‰
- æ–‡ä»¶åˆ é™¤ï¼ˆè½¯åˆ é™¤ + å®šæœŸæ¸…ç†ï¼‰
- ç¼©ç•¥å›¾ç”Ÿæˆï¼ˆå›¾ç‰‡ç±»é™„ä»¶ï¼‰
- åˆ†ç‰‡ä¸Šä¼ ï¼ˆå¤§æ–‡ä»¶æ”¯æŒï¼‰

**ç›®å½•ç»“æ„**
```
OSS Bucket: tzjingtai-erp-files
â”œâ”€â”€ attachments/
â”‚   â”œâ”€â”€ vouchers/           # å‡­è¯é™„ä»¶
â”‚   â”‚   â””â”€â”€ {companyId}/{year}/{month}/{voucherId}/{filename}
â”‚   â”œâ”€â”€ invoices/           # å‘ç¥¨é™„ä»¶
â”‚   â”‚   â””â”€â”€ {companyId}/{year}/{month}/{invoiceId}/{filename}
â”‚   â”œâ”€â”€ accept-bills/       # æ‰¿å…‘æ±‡ç¥¨é™„ä»¶
â”‚   â”‚   â””â”€â”€ {companyId}/{year}/{month}/{billId}/{filename}
â”‚   â””â”€â”€ contracts/          # åˆåŒé™„ä»¶
â”‚       â””â”€â”€ {companyId}/{year}/{contractId}/{filename}
â””â”€â”€ temp/                   # ä¸´æ—¶æ–‡ä»¶ï¼ˆ24å°æ—¶è‡ªåŠ¨æ¸…ç†ï¼‰
```

**é…ç½®ç¤ºä¾‹**
```typescript
// apps/api/src/config/oss.config.ts
export const ossConfig = {
  region: process.env.OSS_REGION,
  accessKeyId: process.env.OSS_ACCESS_KEY_ID,
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET,
  bucket: process.env.OSS_BUCKET,
  secure: true,
  timeout: 60000,
};
```

**æ ¸å¿ƒæ–¹æ³•**
```typescript
// apps/api/src/modules/attachments/oss.service.ts
class OssService {
  async upload(file: Buffer, path: string): Promise<string>
  async getSignedUrl(path: string, expiresIn: number): Promise<string>
  async delete(path: string): Promise<void>
  async exists(path: string): Promise<boolean>
  async generateThumbnail(imagePath: string): Promise<string>
}
```

### 8.2 é˜¿é‡Œäº‘ OCR é›†æˆ

**æŠ€æœ¯é€‰å‹**
- **@alicloud/ocr**ï¼šé˜¿é‡Œäº‘ OCR SDK
- **æ”¯æŒç±»å‹**ï¼šå¢å€¼ç¨å‘ç¥¨ã€é“¶è¡Œæ‰¿å…‘æ±‡ç¥¨ã€èº«ä»½è¯ã€è¥ä¸šæ‰§ç…§ç­‰

**OCR è¯†åˆ«åœºæ™¯**

| åœºæ™¯ | OCR ç±»å‹ | è¯†åˆ«å­—æ®µ |
|------|----------|----------|
| å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ | VATInvoice | å‘ç¥¨ä»£ç ã€å‘ç¥¨å·ç ã€å¼€ç¥¨æ—¥æœŸã€é‡‘é¢ã€ç¨é¢ã€è´­é”€æ–¹ä¿¡æ¯ |
| å¢å€¼ç¨æ™®é€šå‘ç¥¨ | VATInvoice | åŒä¸Š |
| é“¶è¡Œæ‰¿å…‘æ±‡ç¥¨ | BankAcceptance | ç¥¨æ®å·ç ã€å‡ºç¥¨æ—¥æœŸã€åˆ°æœŸæ—¥ã€é‡‘é¢ã€å‡ºç¥¨äººã€æ”¶æ¬¾äºº |
| é“¶è¡Œå›å• | BankReceipt | äº¤æ˜“æ—¥æœŸã€é‡‘é¢ã€å¯¹æ–¹è´¦æˆ·ã€æ‘˜è¦ |
| èº«ä»½è¯ | IDCard | å§“åã€èº«ä»½è¯å·ã€åœ°å€ï¼ˆå¯é€‰ï¼‰ |
| è¥ä¸šæ‰§ç…§ | BusinessLicense | å…¬å¸åç§°ã€ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ã€æ³•äººã€åœ°å€ |

**é…ç½®ç¤ºä¾‹**
```typescript
// apps/api/src/config/ocr.config.ts
export const ocrConfig = {
  accessKeyId: process.env.OCR_ACCESS_KEY_ID,
  accessKeySecret: process.env.OCR_ACCESS_KEY_SECRET,
  endpoint: 'https://ocr.cn-shanghai.aliyuncs.com',
};
```

**æ ¸å¿ƒæ–¹æ³•**
```typescript
// apps/api/src/modules/ocr/ocr.service.ts
class OcrService {
  async recognizeVATInvoice(imageUrl: string): Promise<VATInvoiceOcrResult>
  async recognizeBankAcceptance(imageUrl: string): Promise<BankAcceptanceOcrResult>
  async recognizeBankReceipt(imageUrl: string): Promise<BankReceiptOcrResult>
  async recognizeIDCard(imageUrl: string): Promise<IDCardOcrResult>
  async recognizeBusinessLicense(imageUrl: string): Promise<BusinessLicenseOcrResult>
}
```

**OCR ç»“æœç±»å‹**
```typescript
// packages/types/src/ocr/vat-invoice.ts
export interface VATInvoiceOcrResult {
  invoiceCode: string;           // å‘ç¥¨ä»£ç 
  invoiceNumber: string;          // å‘ç¥¨å·ç 
  invoiceDate: string;            // å¼€ç¥¨æ—¥æœŸ
  invoiceType: string;            // å‘ç¥¨ç±»å‹ï¼ˆä¸“ç¥¨/æ™®ç¥¨ï¼‰
  totalAmount: number;            // ä»·ç¨åˆè®¡
  totalTax: number;               // ç¨é¢
  totalWithoutTax: number;        // ä¸å«ç¨é‡‘é¢
  purchaserName: string;          // è´­æ–¹åç§°
  purchaserTaxNumber: string;     // è´­æ–¹ç¨å·
  sellerName: string;             // é”€æ–¹åç§°
  sellerTaxNumber: string;        // é”€æ–¹ç¨å·
  items: Array<{                  // æ˜ç»†è¡Œ
    name: string;
    specification: string;
    unit: string;
    quantity: number;
    unitPrice: number;
    amount: number;
    taxRate: number;
    tax: number;
  }>;
  confidence: number;             // è¯†åˆ«ç½®ä¿¡åº¦
}
```

### 8.3 é™„ä»¶æ¨¡å—è®¾è®¡

**æ•°æ®æ¨¡å‹**
```prisma
// packages/database/prisma/schema.prisma
model Attachment {
  id              String         @id @default(uuid())
  companyId       String
  company         Company        @relation(fields: [companyId], references: [id])
  entityType      EntityType     // VOUCHER, INVOICE, ACCEPT_BILL, CONTRACT
  entityId        String         // å…³è”ä¸šåŠ¡å•æ® ID
  fileName        String         // åŸå§‹æ–‡ä»¶å
  fileSize        Int            // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  mimeType        String         // MIME ç±»å‹
  ossPath         String         // OSS å­˜å‚¨è·¯å¾„
  thumbnailPath   String?        // ç¼©ç•¥å›¾è·¯å¾„ï¼ˆå›¾ç‰‡ï¼‰
  ocrStatus       OcrStatus      @default(PENDING) // PENDING, PROCESSING, SUCCESS, FAILED
  ocrResult       Json?          // OCR è¯†åˆ«ç»“æœï¼ˆJSONï¼‰
  ocrConfidence   Float?         // OCR ç½®ä¿¡åº¦
  ocrErrorMsg     String?        // OCR é”™è¯¯ä¿¡æ¯
  uploadedBy      String
  uploadedAt      DateTime       @default(now())
  deletedAt       DateTime?
  
  @@index([companyId, entityType, entityId])
  @@index([ocrStatus])
}

enum EntityType {
  VOUCHER
  INVOICE
  ACCEPT_BILL
  CONTRACT
  BANK_RECEIPT
  ID_CARD
  BUSINESS_LICENSE
}

enum OcrStatus {
  PENDING       // å¾…è¯†åˆ«
  PROCESSING    // è¯†åˆ«ä¸­
  SUCCESS       // è¯†åˆ«æˆåŠŸ
  FAILED        // è¯†åˆ«å¤±è´¥
  SKIPPED       // è·³è¿‡è¯†åˆ«ï¼ˆéå›¾ç‰‡æ–‡ä»¶ï¼‰
}
```

**ä¸šåŠ¡æµç¨‹**
```
1. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
   â†“
2. åç«¯æ¥æ”¶æ–‡ä»¶ â†’ ä¸Šä¼ åˆ° OSS
   â†“
3. ä¿å­˜ Attachment è®°å½•ï¼ˆocrStatus: PENDINGï¼‰
   â†“
4. å¼‚æ­¥è§¦å‘ OCR è¯†åˆ«ï¼ˆBull é˜Ÿåˆ—ï¼‰
   â†“
5. OCR è¯†åˆ«å®Œæˆ â†’ æ›´æ–° ocrResult
   â†“
6. å‰ç«¯å±•ç¤ºè¯†åˆ«ç»“æœ â†’ ç”¨æˆ·ç¡®è®¤/ä¿®æ”¹
   â†“
7. ç”¨æˆ·ä¿å­˜ â†’ åˆ›å»ºä¸šåŠ¡å•æ®ï¼ˆå‘ç¥¨/æ‰¿å…‘ç­‰ï¼‰
```

**API æ¥å£**
```typescript
// ä¸Šä¼ é™„ä»¶
POST /api/v1/attachments/upload
Content-Type: multipart/form-data
Body: {
  file: File,
  entityType: 'INVOICE',
  entityId: 'xxx' (å¯é€‰)
}

// è·å–é™„ä»¶åˆ—è¡¨
GET /api/v1/attachments?entityType=INVOICE&entityId=xxx

// è·å–é™„ä»¶è¯¦æƒ…ï¼ˆå« OCR ç»“æœï¼‰
GET /api/v1/attachments/:id

// è·å–é™„ä»¶ä¸‹è½½é“¾æ¥ï¼ˆç­¾å URLï¼‰
GET /api/v1/attachments/:id/download

// è§¦å‘ OCR è¯†åˆ«
POST /api/v1/attachments/:id/ocr

// åˆ é™¤é™„ä»¶
DELETE /api/v1/attachments/:id
```

### 8.4 å‰ç«¯é™„ä»¶ç»„ä»¶

**AttachmentUploader ç»„ä»¶**
```typescript
// packages/ui/src/components/attachment-uploader.tsx
interface AttachmentUploaderProps {
  entityType: EntityType;
  entityId?: string;
  maxFiles?: number;
  maxSize?: number;
  accept?: string;
  enableOcr?: boolean;
  onUploadSuccess?: (attachment: Attachment) => void;
  onOcrComplete?: (result: OcrResult) => void;
}
```

**åŠŸèƒ½ç‰¹æ€§**
- æ‹–æ‹½ä¸Šä¼ 
- å¤šæ–‡ä»¶ä¸Šä¼ 
- ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
- æ–‡ä»¶é¢„è§ˆï¼ˆå›¾ç‰‡/PDFï¼‰
- OCR è¯†åˆ«çŠ¶æ€æ˜¾ç¤º
- OCR ç»“æœå±•ç¤ºä¸ç¼–è¾‘

### 8.5 ç¯å¢ƒå˜é‡é…ç½®

```env
# é˜¿é‡Œäº‘ OSS
OSS_REGION="oss-cn-shanghai"
OSS_ACCESS_KEY_ID="your-access-key-id"
OSS_ACCESS_KEY_SECRET="your-access-key-secret"
OSS_BUCKET="tzjingtai-erp-files"
OSS_ENDPOINT="https://oss-cn-shanghai.aliyuncs.com"

# é˜¿é‡Œäº‘ OCR
OCR_ACCESS_KEY_ID="your-access-key-id"
OCR_ACCESS_KEY_SECRET="your-access-key-secret"
OCR_ENDPOINT="https://ocr.cn-shanghai.aliyuncs.com"

# æ–‡ä»¶ä¸Šä¼ é™åˆ¶
MAX_FILE_SIZE=10485760  # 10MB
ALLOWED_FILE_TYPES="image/jpeg,image/png,image/jpg,application/pdf"
```

### 8.6 å®‰å…¨ç­–ç•¥

- **è®¿é—®æ§åˆ¶**ï¼šæ‰€æœ‰æ–‡ä»¶é€šè¿‡ç­¾å URL è®¿é—®ï¼Œæœ‰æ•ˆæœŸ 1 å°æ—¶
- **æƒé™æ ¡éªŒ**ï¼šä¸‹è½½å‰éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥é™„ä»¶
- **æ–‡ä»¶æ‰«æ**ï¼šä¸Šä¼ æ—¶è¿›è¡Œç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼‰
- **æ•æ„Ÿä¿¡æ¯**ï¼šOCR ç»“æœä¸­çš„æ•æ„Ÿä¿¡æ¯è„±æ•å­˜å‚¨
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤æ“ä½œ

### 8.7 æˆæœ¬ä¼˜åŒ–

- **å­˜å‚¨ç±»å‹**ï¼šæ ‡å‡†å­˜å‚¨ï¼ˆçƒ­æ•°æ®ï¼‰+ å½’æ¡£å­˜å‚¨ï¼ˆå†å²æ•°æ®ï¼‰
- **ç”Ÿå‘½å‘¨æœŸè§„åˆ™**ï¼š
  - temp/ ç›®å½•æ–‡ä»¶ 24 å°æ—¶è‡ªåŠ¨åˆ é™¤
  - 3 å¹´ä»¥ä¸Šé™„ä»¶è½¬å½’æ¡£å­˜å‚¨
- **CDN åŠ é€Ÿ**ï¼šé«˜é¢‘è®¿é—®æ–‡ä»¶ä½¿ç”¨ CDNï¼ˆå¯é€‰ï¼‰
- **å‹ç¼©ç­–ç•¥**ï¼šå›¾ç‰‡è‡ªåŠ¨å‹ç¼©ï¼ˆOSS å›¾ç‰‡å¤„ç†ï¼‰

---

## 9. æƒé™æ§åˆ¶

### 9.1 RBAC æ¨¡å‹

```
User â†’ UserRole â†’ Role â†’ RolePermission â†’ Permission
```

### 9.2 æƒé™ç²’åº¦

- **æ¨¡å—çº§**ï¼šfinance, business, system
- **æ“ä½œçº§**ï¼šcreate, read, update, delete, approve, post
- **æ•°æ®çº§**ï¼š
  - å…¬å¸éš”ç¦»ï¼ˆcompanyIdï¼‰
  - è´¦ç°¿éš”ç¦»ï¼ˆledgerIdï¼‰
  - çŠ¶æ€éš”ç¦»ï¼ˆDraft å¯æ”¹ï¼ŒPosted ä¸å¯æ”¹ï¼‰

### 9.3 å®ç°æ–¹å¼

**åç«¯å®ˆå«ï¼ˆGuardï¼‰**
```typescript
@UseGuards(JwtAuthGuard, PermissionGuard)
@RequirePermissions('voucher:create')
@Controller('vouchers')
export class VoucherController {}
```

**å‰ç«¯æƒé™ Hook**
```typescript
const { hasPermission } = usePermissions();
if (hasPermission('voucher:approve')) {
  // æ˜¾ç¤ºå®¡æ ¸æŒ‰é’®
}
```

---

## 10. æ—¥å¿—ç³»ç»Ÿ

### 10.1 æ—¥å¿—æ¡†æ¶ï¼šWinston

**æ—¥å¿—çº§åˆ«**
- errorï¼šé”™è¯¯æ—¥å¿—
- warnï¼šè­¦å‘Šæ—¥å¿—
- infoï¼šä¿¡æ¯æ—¥å¿—
- debugï¼šè°ƒè¯•æ—¥å¿—

**æ—¥å¿—è¾“å‡º**
- æ§åˆ¶å°ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- æ–‡ä»¶ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
  - `logs/error.log`
  - `logs/combined.log`
- æ•°æ®åº“ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰

### 10.2 å®¡è®¡æ—¥å¿—ï¼ˆAuditLogï¼‰

**è®°å½•å†…å®¹**
- ç”¨æˆ·æ“ä½œï¼ˆuserId, usernameï¼‰
- æ“ä½œç±»å‹ï¼ˆaction: CREATE, UPDATE, DELETE, APPROVE, POSTï¼‰
- æ“ä½œå¯¹è±¡ï¼ˆentityType, entityIdï¼‰
- æ“ä½œå‰åæ•°æ®ï¼ˆoldValue, newValueï¼‰
- IP åœ°å€ã€æ—¶é—´æˆ³

**å®ç°æ–¹å¼**
```typescript
@UseInterceptors(AuditLogInterceptor)
@Post()
async create(@Body() dto: CreateVoucherDto) {}
```

---

## 11. API è®¾è®¡è§„èŒƒ

### 11.1 RESTful API

**URL è§„èŒƒ**
```
GET    /api/v1/vouchers          # åˆ—è¡¨
GET    /api/v1/vouchers/:id      # è¯¦æƒ…
POST   /api/v1/vouchers          # åˆ›å»º
PATCH  /api/v1/vouchers/:id      # æ›´æ–°
DELETE /api/v1/vouchers/:id      # åˆ é™¤
POST   /api/v1/vouchers/:id/post # è¿‡è´¦ï¼ˆåŠ¨ä½œï¼‰
```

### 11.2 å“åº”æ ¼å¼

**æˆåŠŸå“åº”**
```json
{
  "success": true,
  "data": { ... },
  "message": "æ“ä½œæˆåŠŸ"
}
```

**é”™è¯¯å“åº”**
```json
{
  "success": false,
  "error": {
    "code": "VOUCHER_NOT_BALANCED",
    "message": "å‡­è¯å€Ÿè´·ä¸å¹³è¡¡",
    "details": { ... }
  }
}
```

### 11.3 åˆ†é¡µè§„èŒƒ

**è¯·æ±‚å‚æ•°**
```
GET /api/v1/vouchers?page=1&pageSize=20&sortBy=voucherDate&order=desc
```

**å“åº”æ ¼å¼**
```json
{
  "success": true,
  "data": {
    "items": [...],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  }
}
```

---

## 12. å®‰å…¨ç­–ç•¥

### 12.1 è®¤è¯æ–¹å¼

- **JWT Token**ï¼šæœ‰æ•ˆæœŸ 24 å°æ—¶
- **Refresh Token**ï¼šæœ‰æ•ˆæœŸ 7 å¤©
- **å¯†ç åŠ å¯†**ï¼šbcryptï¼ˆsalt rounds: 10ï¼‰

### 12.2 å®‰å…¨æªæ–½

- CORS é…ç½®ï¼ˆç™½åå•ï¼‰
- Helmet.jsï¼ˆHTTP å¤´å®‰å…¨ï¼‰
- Rate Limitingï¼ˆAPI é™æµï¼‰
- SQL æ³¨å…¥é˜²æŠ¤ï¼ˆPrisma å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- XSS é˜²æŠ¤ï¼ˆè¾“å…¥éªŒè¯ + è¾“å‡ºè½¬ä¹‰ï¼‰
- CSRF é˜²æŠ¤ï¼ˆSameSite Cookieï¼‰

---

## 13. æ€§èƒ½ä¼˜åŒ–

### 13.1 æ•°æ®åº“ä¼˜åŒ–

- ç´¢å¼•ä¼˜åŒ–
- æŸ¥è¯¢ä¼˜åŒ–ï¼ˆé¿å… N+1ï¼‰
- è¿æ¥æ± é…ç½®
- åˆ†é¡µæŸ¥è¯¢
- ç¼“å­˜ç­–ç•¥ï¼ˆRedisï¼Œå¯é€‰ï¼‰

### 13.2 å‰ç«¯ä¼˜åŒ–

- Next.js SSR/SSG
- ä»£ç åˆ†å‰²ï¼ˆåŠ¨æ€å¯¼å…¥ï¼‰
- å›¾ç‰‡ä¼˜åŒ–ï¼ˆnext/imageï¼‰
- TanStack Query ç¼“å­˜
- è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§åˆ—è¡¨ï¼‰

---

## 14. éƒ¨ç½²æ¶æ„

### 14.1 å¼€å‘ç¯å¢ƒ

```
Node.js 24 LTS (æœ¬åœ°è¿è¡Œ)
PostgreSQL 17 (Docker)
pnpm 9+ (åŒ…ç®¡ç†å™¨)
```

### 14.2 ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰

**æ³¨æ„**ï¼šç”Ÿäº§ç¯å¢ƒæ–‡ä»¶å­˜å‚¨ä½¿ç”¨é˜¿é‡Œäº‘ OSS

```
å‰ç«¯ï¼šVercel / è‡ªå»ºæœåŠ¡å™¨ï¼ˆNginxï¼‰
åç«¯ï¼šDocker + PM2 / Kubernetes
æ•°æ®åº“ï¼šPostgreSQLï¼ˆäº‘æœåŠ¡ / è‡ªå»ºï¼‰
æ–‡ä»¶å­˜å‚¨ï¼šé˜¿é‡Œäº‘ OSS
OCR æœåŠ¡ï¼šé˜¿é‡Œäº‘ OCR
```

---

## 15. å¼€å‘è§„èŒƒ

### 15.1 ä»£ç è§„èŒƒ

- **ESLint**ï¼šä»£ç æ£€æŸ¥
- **Prettier**ï¼šä»£ç æ ¼å¼åŒ–
- **Husky**ï¼šGit Hooks
- **Commitlint**ï¼šæäº¤ä¿¡æ¯è§„èŒƒ

### 15.2 Git å·¥ä½œæµ

- **åˆ†æ”¯ç­–ç•¥**ï¼šGit Flow
  - mainï¼šç”Ÿäº§åˆ†æ”¯
  - developï¼šå¼€å‘åˆ†æ”¯
  - feature/*ï¼šåŠŸèƒ½åˆ†æ”¯
  - hotfix/*ï¼šä¿®å¤åˆ†æ”¯

### 15.3 æµ‹è¯•ç­–ç•¥

- **å•å…ƒæµ‹è¯•**ï¼šJest
- **é›†æˆæµ‹è¯•**ï¼šSupertest
- **E2E æµ‹è¯•**ï¼šPlaywrightï¼ˆå¯é€‰ï¼‰

---

## 16. æŠ€æœ¯å€ºåŠ¡ç®¡ç†

### 16.1 å¾…ä¼˜åŒ–é¡¹

- [ ] Redis ç¼“å­˜å±‚
- [ ] æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆBullï¼‰
- [ ] å¾®æœåŠ¡æ‹†åˆ†ï¼ˆå¯é€‰ï¼‰
- [ ] GraphQL APIï¼ˆå¯é€‰ï¼‰
- [ ] å®æ—¶é€šçŸ¥ï¼ˆWebSocketï¼‰

### 16.2 ç›‘æ§å‘Šè­¦

- åº”ç”¨ç›‘æ§ï¼ˆå¯é€‰ï¼šSentryï¼‰
- æ€§èƒ½ç›‘æ§ï¼ˆå¯é€‰ï¼šNew Relicï¼‰
- æ—¥å¿—èšåˆï¼ˆå¯é€‰ï¼šELKï¼‰

---

## 17. æŠ€æœ¯é€‰å‹ç†ç”±

| æŠ€æœ¯ | ç†ç”± |
|------|------|
| æŠ€æœ¯ | ç†ç”± |
|------|------|
| Node.js 24 LTS | é•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼Œæ€§èƒ½ä¼˜å¼‚ï¼Œç”Ÿæ€æˆç†Ÿ |
| Turborepo | Monorepo ä¸“ç”¨ï¼Œå¢é‡æ„å»ºï¼Œè¿œç¨‹ç¼“å­˜ |
| pnpm | å¿«é€Ÿã€èŠ‚çœç£ç›˜ç©ºé—´ã€ä¸¥æ ¼çš„ä¾èµ–ç®¡ç† |
| Next.js 15 | æœ€æ–° App Routerï¼ŒReact 19 æ”¯æŒï¼Œæ€§èƒ½ä¼˜åŒ– |
| React 19 | æœ€æ–°ç‰¹æ€§ï¼Œæ€§èƒ½æå‡ï¼ŒServer Components |
| Nest.js 11 | ä¼ä¸šçº§æ¡†æ¶ï¼Œæ¨¡å—åŒ–ï¼Œä¾èµ–æ³¨å…¥ï¼Œæœ€æ–°ç‰¹æ€§ |
| Prisma 6 | ç±»å‹å®‰å…¨ï¼Œè¿ç§»ç®¡ç†ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼Œæœ€æ–°ç‰¹æ€§ |
| PostgreSQL 17 | æœ€æ–°ç¨³å®šç‰ˆï¼Œæ€§èƒ½æå‡ï¼Œæ–°ç‰¹æ€§æ”¯æŒ |
| Tailwind CSS 4 | æœ€æ–°ç‰ˆæœ¬ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼Œæ–°ç‰¹æ€§ |
| shadcn/ui | å¯å®šåˆ¶ï¼Œæ— ä¾èµ–é”å®šï¼Œä»£ç å¯æ§ï¼ŒæŒç»­æ›´æ–° |
| Winston | çµæ´»ï¼Œå¤šè¾“å‡ºï¼Œç”Ÿäº§çº§ |
| é˜¿é‡Œäº‘ OSS | ç¨³å®šå¯é ï¼Œæˆæœ¬å¯æ§ï¼Œå›½å†…è®¿é—®é€Ÿåº¦å¿« |
| é˜¿é‡Œäº‘ OCR | è¯†åˆ«å‡†ç¡®ç‡é«˜ï¼Œæ”¯æŒå¤šç§ç¥¨æ®ç±»å‹ï¼ŒæŒ‰é‡ä»˜è´¹ |

---

## 18. é™„å½•

### 18.1 ç¯å¢ƒå˜é‡é…ç½®

```env
# æ•°æ®åº“
DATABASE_URL="postgresql://user:password@localhost:5432/tzjingtai_erp"

# JWT
JWT_SECRET="your-secret-key"
JWT_EXPIRES_IN="24h"

# åº”ç”¨
NODE_ENV="development"
PORT=3000
API_PREFIX="/api/v1"

# é˜¿é‡Œäº‘ OSS
OSS_REGION="oss-cn-shanghai"
OSS_ACCESS_KEY_ID="your-access-key-id"
OSS_ACCESS_KEY_SECRET="your-access-key-secret"
OSS_BUCKET="tzjingtai-erp-files"
OSS_ENDPOINT="https://oss-cn-shanghai.aliyuncs.com"

# é˜¿é‡Œäº‘ OCR
OCR_ACCESS_KEY_ID="your-access-key-id"
OCR_ACCESS_KEY_SECRET="your-access-key-secret"
OCR_ENDPOINT="https://ocr.cn-shanghai.aliyuncs.com"

# æ–‡ä»¶ä¸Šä¼ é™åˆ¶
MAX_FILE_SIZE=10485760  # 10MB
ALLOWED_FILE_TYPES="image/jpeg,image/png,image/jpg,application/pdf"
```

### 18.2 å¯åŠ¨å‘½ä»¤ï¼ˆMonorepoï¼‰

```bash
# å®‰è£… pnpmï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
npm install -g pnpm

# å®‰è£…ä¾èµ–
pnpm install

# ç”Ÿæˆ Prisma Client
pnpm db:generate

# æ•°æ®åº“è¿ç§»
pnpm db:migrate

# å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆå‰åç«¯åŒæ—¶å¯åŠ¨ï¼‰
pnpm dev

# å•ç‹¬å¯åŠ¨å‰ç«¯
cd apps/web
pnpm dev

# å•ç‹¬å¯åŠ¨åç«¯
cd apps/api
pnpm start:dev

# æ„å»ºæ‰€æœ‰åº”ç”¨
pnpm build

# ç±»å‹æ£€æŸ¥
pnpm type-check

# ä»£ç æ£€æŸ¥
pnpm lint
```



---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-11-14  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
