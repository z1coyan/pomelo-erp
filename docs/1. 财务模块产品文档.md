
# 📘 tzjingtai-erp  
# **全局产品需求文档（Tech-Oriented PRD v1.0）**

---

# 1. 产品定位

**tzjingtai-erp** 是为「精泰电气集团（多公司） + 外贸业务 + 制造业」打造的  
**业务财务一体化 ERP 系统**，目标：

- 多公司、多账簿、多币种财务核算  
- 承兑汇票、增值税发票、资金、应收应付、库存入出库  
- 基于事件驱动的自动化会计凭证体系（Event Layer）  
- 灵活的会计规则配置（PostingRule）  
- 保证所有业务均可追溯到财务（Audit Trail）  
- 简洁可控、可持续扩展（未来国产化 ERP 内核）

---

# 2. 产品范围（Scope）

## ✔ tzjingtai-erp 具备以下功能

### ◼ 财务会计（核心）
- 会计科目（自定义）  
- 会计科目明细（支持多层级）  
- 辅助核算（客户/供应商/项目/部门/员工/银行账户等）  
- 多账簿、多公司、独立会计体系  
- 多币种、多汇率  
- 会计事件层（AccountingEvent）  
- 自动生成凭证（来自 Event Layer）  
- 手工凭证录入  
- 凭证审核、过账、红冲、反审  
- 总账（GL Entry）  
- 会计期间管理  
- 附件中心（凭证、单据、发票）

### ◼ 业务模块
- 承兑汇票全流程  
- 增值税发票管理（专票、普票、红字）  
- 银行付款/收款/转账  
- 采购发票 → 应付  
- 销售发票 → 应收  
- 库存入库/出库  
- 应收应付核销  
- 单据附件、日志跟踪

### ◼ 系统功能  
- 用户/角色/权限（RBAC）  
- 前端菜单管理  
- 国际化（中/英）  
- 文件/附件系统  
- 操作日志（审计日志）  

---

## ❌ tzjingtai-erp 不包含以下功能
- MRP/MES  
- WMS（货位/条码）  
- CRM  
- HR  
- 固定资产（未来可扩展）  
- 高级成本核算  

---

# 3. 用户角色

| 角色 | 职责 |
|------|------|
| 总经理 | 数据查看/授权 |
| 财务主管 | 制定科目体系、规则、审核凭证 |
| 会计 | 发票、承兑、总账、凭证审核 |
| 出纳 | 资金业务（转账/付款/收款） |
| 业务员 | 开票、采购/销售业务录入 |
| 仓库员 | 库存入库/出库 |
| 系统管理员 | 用户、角色、权限、菜单管理 |

---

# 4. 业务流程（全局）

```
业务单据 → 会计事件（AccountingEvent）
        → 会计规则（PostingRule）
        → 自动生成会计凭证（Voucher Draft）
        → 审核过账（Post）
        → 写入总账（GL Entry）
        → 报表（资产负债表、利润表）
```

---

# 5. 核心域模型

## 财务域
Company, Ledger, ChartOfAccount, ChartOfAccountItem, Currency, ExchangeRate,  
PostingRule, AccountingEvent, Voucher, VoucherItem, VoucherItemAux, GLEntry

## 业务域
AcceptBill, VatInvoice, InventoryReceipt, InventoryIssue, Payment, Receipt

## 系统域
User, Role, Permission, Menu, Attachment, AuditLog

---

# 6. 会计事件层（Event Layer）

**事件层职责**
- 捕获业务动作  
- 保存业务快照 payload  
- 作为唯一会计触发点  
- 匹配 PostingRule  
- 自动生成凭证草稿  

**事件状态机**
- Pending  
- DraftVoucher  
- Posted  
- Reversed  

**EventType enum（示例）**
- MANUAL_VOUCHER  
- ACCEPT_BILL_RECEIVED  
- ACCEPT_BILL_ISSUED  
- ACCEPT_BILL_DISCOUNT  
- BANK_TRANSFER  
- BANK_PAYMENT  
- BANK_RECEIPT  
- AP_INVOICE_CREATED  
- AR_INVOICE_CREATED  
- INVENTORY_RECEIPT  
- INVENTORY_ISSUE  

---

# 7. 会计规则（PostingRule）

PostingRule 定义账簿级规则：

```
eventType + role → 会计科目 + 借贷方向 + 金额来源 + 辅助核算要求
```

示例：

```
ACCEPT_BILL_RECEIVED:
  note_asset → 借：应收票据
  settled_receivable → 贷：应收账款
```

字段：

- ledgerId  
- eventType  
- role  
- chartOfAccountItemId  
- debitCreditFlag  
- amountFormula  
- requiredAuxTypes  
- enabled  
- effectiveDate  

---

# 8. 会计凭证（Voucher）

### 生命周期
```
Draft → Posted → Reversed
```

### 特性
- 所有凭证均来自 Event  
- Posted 不可修改，必须红冲  
- 金额支持原币 + 本币  
- 支持辅助核算  
- 支持附件  

---

# 9. 承兑汇票模块（Accept Bill）

支持流程：

- 收票  
- 开票  
- 背书  
- 贴现  
- 到期兑付  
- 作废  
- 红冲  

所有动作均产生对应 EventType。

---

# 10. 增值税发票模块（VAT Invoice）

- 专票/普票/红字  
- 发票认证状态  
- 附件PDF  
- 自动触发 AR/AP 类事件  

---

# 11. 资金模块（Cash/Bank）

支持：

- 银行收款（BANK_RECEIPT）  
- 银行付款（BANK_PAYMENT）  
- 银行转账（BANK_TRANSFER）  
- 手续费/利息（BANK_FEE）  

---

# 12. 权限体系

- RBAC：用户 → 角色 → 权限  
- 公司隔离  
- 账簿隔离  
- 凭证状态隔离（Draft可改，Posted不可改）  

---

# 13. 系统架构

```
前端 (Next.js + shadcn)
↓
后端 API (Node.js + TS)
↓
Domain Layer (Event / PostingRule / Voucher Engine)
↓
Prisma ORM (多公司、多账簿、多科目)
```

底层原则：

- 事件驱动  
- 科目可配置  
- 高可追溯性  
- 强一致性  
- 多公司隔离  

---

# 14. 非功能需求

- 高一致性  
- 全链路审计  
- 模块解耦  
- 国际化  
- 前端需支持财务录入操作体验（快捷键、批量行编辑）

---

# 15. 路线图（Roadmap）

**V1.0**
- 核心业务 + 核心财务闭环  
- 承兑/发票/库存/资金  
- EventLayer + PostingRule
